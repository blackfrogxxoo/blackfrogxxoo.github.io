<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="介绍“高仿飞书日历”中月视图的实现思路和技术细节">
<meta property="og:type" content="article">
<meta property="og:title" content="【Android自定义View】高仿飞书日历--月视图">
<meta property="og:url" content="http://example.com/2023/04/08/schedule3/index.html">
<meta property="og:site_name" content="blackfrog">
<meta property="og:description" content="介绍“高仿飞书日历”中月视图的实现思路和技术细节">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e7a15879bcc460ebd915f6dd6015f14~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da24e40285134cfab25eb37c91b7cb7c~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2023-04-08T04:12:57.000Z">
<meta property="article:modified_time" content="2023-09-06T10:23:13.413Z">
<meta property="article:author" content="blackfrog">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e7a15879bcc460ebd915f6dd6015f14~tplv-k3u1fbpfcp-watermark.image">


<link rel="canonical" href="http://example.com/2023/04/08/schedule3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/04/08/schedule3/","path":"2023/04/08/schedule3/","title":"【Android自定义View】高仿飞书日历--月视图"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【Android自定义View】高仿飞书日历--月视图 | blackfrog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">blackfrog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">慎 敬 勤 恒</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E7%A1%AE%E5%AE%9A"><span class="nav-number">1.</span> <span class="nav-text">需求确定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E5%85%88%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">框架先行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%83%E5%B1%80-%E6%B8%B2%E6%9F%93%E6%A1%86%E6%9E%B6"><span class="nav-number">2.1.</span> <span class="nav-text">布局&amp;渲染框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%96%E5%B1%82"><span class="nav-number">2.1.1.</span> <span class="nav-text">外层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%B1%82"><span class="nav-number">2.1.2.</span> <span class="nav-text">内层</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%8E%86%E6%A1%86%E6%9E%B6"><span class="nav-number">2.2.</span> <span class="nav-text">日历框架</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text">具体实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%92%8C%E5%B8%83%E5%B1%80DayView"><span class="nav-number">3.1.</span> <span class="nav-text">添加和布局DayView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%95%E5%BC%80%E5%92%8C%E6%94%B6%E8%B5%B7"><span class="nav-number">3.2.</span> <span class="nav-text">展开和收起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BB%91%E5%8A%A8%E5%86%B2%E7%AA%81"><span class="nav-number">3.3.</span> <span class="nav-text">滑动冲突</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%80%E5%89%B2"><span class="nav-number">4.</span> <span class="nav-text">杀割</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">blackfrog</p>
  <div class="site-description" itemprop="description">blackfrog的个人博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/08/schedule3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="blackfrog">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="blackfrog">
      <meta itemprop="description" content="blackfrog的个人博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【Android自定义View】高仿飞书日历--月视图 | blackfrog">
      <meta itemprop="description" content="介绍“高仿飞书日历”中月视图的实现思路和技术细节">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【Android自定义View】高仿飞书日历--月视图
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-08 12:12:57" itemprop="dateCreated datePublished" datetime="2023-04-08T12:12:57+08:00">2023-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-09-06 18:23:13" itemprop="dateModified" datetime="2023-09-06T18:23:13+08:00">2023-09-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%87%AA%E5%AE%9A%E4%B9%89View/" itemprop="url" rel="index"><span itemprop="name">自定义View</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">介绍“高仿飞书日历”中月视图的实现思路和技术细节</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><meta name="referrer" content="no-referrer" />


<p>前几天笔者陆续发布了“高仿飞书日历”系列的两篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7217425505925054521">【Android自定义View】高仿飞书日历（一） – 三日视图</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7218459472919085114">【Android自定义View】高仿飞书日历（二） – 日视图</a></p>
<p>今天继续分享：月视图。先上效果图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e7a15879bcc460ebd915f6dd6015f14~tplv-k3u1fbpfcp-watermark.image" alt="单月视图.gif"></p>
<h2 id="需求确定"><a href="#需求确定" class="headerlink" title="需求确定"></a>需求确定</h2><p>月视图的显示和交互相对简单一点。</p>
<ul>
<li>每页展示一个月的月历，左右滑动切换上&#x2F;下月。</li>
<li>月历中每天的日期下展示当天的日程名称列表，如果展示不完整则在日期右侧展示剩余日程数。</li>
<li>点击选中某一天时，以这一天所在的周，上下展开。展开时，在中间显示详细的日程列表，如果没有日程则显示空页面。左右滑动切换上&#x2F;下一天。</li>
<li>展开状态下，日程列表可以左右滑动。点击选中的日期可收起日程列表，点击其他日期可切换日程列表。</li>
</ul>
<h2 id="框架先行"><a href="#框架先行" class="headerlink" title="框架先行"></a>框架先行</h2><h3 id="布局-渲染框架"><a href="#布局-渲染框架" class="headerlink" title="布局&amp;渲染框架"></a>布局&amp;渲染框架</h3><p>为便于理解，我们不妨将月视图的布局分为外层和内层。</p>
<h4 id="外层"><a href="#外层" class="headerlink" title="外层"></a>外层</h4><p>从效果图和需求中可以看出，月视图整体上就是一个左右翻页控件，那么<code>ViewPager/ViewPager2/RecyclerView</code>都是可以考虑的。笔者对<code>RecyclerView</code>比较熟悉，就选用了<code>RecyclerView</code>+<code>PagerSnapHelper</code>来构建了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class MonthGroup @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : RecyclerView(context, attrs) &#123;</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        layoutManager = LinearLayoutManager(context, HORIZONTAL, false)</span><br><span class="line">        PagerSnapHelper().attachToRecyclerView(this)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前在外层布局构建阶段，那就暂时不考虑内层的布局细节了。我们可以考虑组合<code>GridView</code>和<code>ViewPager</code>这样的方式来构建月历布局，但笔者喜欢自由发挥，就先用一个自定义<code>ViewGroup</code>占坑吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class MonthView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0</span><br><span class="line">) : ViewGroup(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) &#123;</span><br><span class="line">        // TODO 布局</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为<code>MonthGroup</code>定义一个<code>adapter</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class MonthAdapter : RecyclerView.Adapter&lt;VH&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    private val monthCount: Int = 0 // TODO 计算月份数</span><br><span class="line"></span><br><span class="line">    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): VH &#123;</span><br><span class="line">        return VH(parent.context)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun getItemCount() = monthCount</span><br><span class="line"></span><br><span class="line">    override fun onBindViewHolder(holder: VH, position: Int) &#123;</span><br><span class="line">        // TODO 为MonthView绑定日期和日程数据</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class VH(context: Context) : ViewHolder(MonthView(context).apply &#123;</span><br><span class="line">    layoutParams = LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>让<code>MonthGroup</code>绑定一个adapter，为了拿到当前的月份，我们定义一个<code>lastPosition</code>字段，并在<code>OnScrollListener</code>中计算更新<code>lastPosition</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class MonthGroup @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : RecyclerView(context, attrs) &#123;</span><br><span class="line">    private var lastPosition = -1</span><br><span class="line">    init &#123;</span><br><span class="line">        layoutManager = LinearLayoutManager(context, HORIZONTAL, false)</span><br><span class="line">        PagerSnapHelper().attachToRecyclerView(this)</span><br><span class="line">        adapter = MonthAdapter()</span><br><span class="line">        </span><br><span class="line">        addOnScrollListener(object : OnScrollListener() &#123;</span><br><span class="line">            override fun onScrollStateChanged(recyclerView: RecyclerView, newState: Int) &#123;</span><br><span class="line">                if (newState == SCROLL_STATE_IDLE) &#123;</span><br><span class="line">                    val llm = recyclerView.layoutManager as LinearLayoutManager</span><br><span class="line">                    val position = llm.findFirstCompletelyVisibleItemPosition()</span><br><span class="line">                    if (position != -1 &amp;&amp; lastPosition != position) &#123;</span><br><span class="line">                        lastPosition = position</span><br><span class="line">                        // TODO 处理选中某月份的逻辑</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样月视图的外层布局&amp;渲染框架就完成了。</p>
<h4 id="内层"><a href="#内层" class="headerlink" title="内层"></a>内层</h4><p>考虑一下，效果图中，显示“日 一 二 三..”那一行(header)是固定的，也不可交互，我们可以直接在<code>onDraw()</code>方法中绘制它们。而日期Item和日程列表的布局需要处理动态更新，在<code>onLayout()</code>中去处理更加直观。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class MonthView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0</span><br><span class="line">) : ViewGroup(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    private val paint = Paint(Paint.ANTI_ALIAS_FLAG).apply &#123;</span><br><span class="line">        textSize = 11f.dp</span><br><span class="line">    &#125;</span><br><span class="line">    private val topPadding = 26f.dp</span><br><span class="line">    init &#123;</span><br><span class="line">        setWillNotDraw(false)</span><br><span class="line">        // topPadding以上用于绘制周header，以下用于布局子View</span><br><span class="line">        updatePadding(top = topPadding.roundToInt())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onDraw(canvas: Canvas) &#123;</span><br><span class="line">        super.onDraw(canvas)</span><br><span class="line">        paint.color = ScheduleConfig.colorBlack3</span><br><span class="line">        // TODO 绘制header</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) &#123;</span><br><span class="line">        // TODO 布局日期Item和日程列表</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日期Item中需要绘制日期、日程和选中状态，就简单地自定义一个<code>View</code>来渲染吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class DayView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0</span><br><span class="line">) : View(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    private val paint = Paint(Paint.ANTI_ALIAS_FLAG)</span><br><span class="line">    override fun onDraw(canvas: Canvas) &#123;</span><br><span class="line">        super.onDraw(canvas)</span><br><span class="line">        drawDate(canvas)</span><br><span class="line">        drawTasks(canvas)</span><br><span class="line">        drawArrow(canvas)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun drawDate(canvas: Canvas) &#123;</span><br><span class="line">        // TODO 绘制日期</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private fun drawTasks(canvas: Canvas) &#123;</span><br><span class="line">        // TODO 绘制日程</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private fun drawArrow(canvas: Canvas) &#123;</span><br><span class="line">        // TODO 绘制选中箭头</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时，我们需要让每一个<code>MonthView</code>去添加一些<code>DayView</code>到它的布局中。简单处理，就在<code>onAttachedToWindow()</code>中添加，在<code>onDetachedFromWindow()</code>中清除好了。添加多少个呢？这就需要根据日历数据去计算了，这里暂时不处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class MonthView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0</span><br><span class="line">) : ViewGroup(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    ...</span><br><span class="line">    override fun onAttachedToWindow() &#123;</span><br><span class="line">        super.onAttachedToWindow()</span><br><span class="line">        // TODO addView(DayView(context))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onDetachedFromWindow() &#123;</span><br><span class="line">        super.onDetachedFromWindow()</span><br><span class="line">        removeAllViews()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别忘了还有一个展开状态，我们需要再添加一个日程列表在<code>MonthView</code>中，这个日程列表是可以左右滑动的，我们继承一个<code>RecyclerView</code>来实现，它就是一个常规的<code>RecyclerView</code>的使用，比较枯燥，这里就点到为止了哈。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 日程列表外层</span><br><span class="line">class DailyTaskListViewGroup @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : RecyclerView(context, attrs) &#123;</span><br><span class="line">    ...</span><br><span class="line">    inner class Adapter() :</span><br><span class="line">        RecyclerView.Adapter&lt;VH&gt;() &#123;</span><br><span class="line">        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): VH &#123;</span><br><span class="line">            return VH(DailyTaskListView(parent.context).apply &#123;</span><br><span class="line">                layoutParams = LayoutParams(LayoutParams.MATCH_PARENT,LayoutParams.MATCH_PARENT)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun getItemCount() = 7</span><br><span class="line"></span><br><span class="line">        override fun onBindViewHolder(holder: VH, position: Int) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class VH(val dailyTaskListView: DailyTaskListView) : ViewHolder(dailyTaskListView)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 日程列表内层，包含一个上下滑动的日程列表和一个空页面</span><br><span class="line">class DailyTaskListView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : FrameLayout(context, attrs) &#123;</span><br><span class="line">    private val recyclerView: RecyclerView</span><br><span class="line">    private val emptyView: TextView</span><br><span class="line">    init &#123;</span><br><span class="line">        inflate(context, R.layout.daily_task_list_view, this)</span><br><span class="line">        recyclerView = findViewById(R.id.recyclerView)</span><br><span class="line">        emptyView = findViewById(R.id.emptyView)</span><br><span class="line">        emptyView.text = buildSpannedString &#123;</span><br><span class="line">            append(&quot;暂无日程安排，&quot;)</span><br><span class="line">            color(ScheduleConfig.colorBlue1) &#123;</span><br><span class="line">                append(&quot;点击创建&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        emptyView.setOnClickListener &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    inner class Adapter : RecyclerView.Adapter&lt;ViewHolder&gt;() &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class VH(itemView: View) : ViewHolder(itemView) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们把日程列表<code>DailyTaskListViewGroup</code>直接添加到<code>MonthView</code>中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class MonthView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null, defStyleAttr: Int = 0</span><br><span class="line">) : ViewGroup(context, attrs, defStyleAttr) &#123;</span><br><span class="line">    private val dailyTaskListViewGroup: DailyTaskListViewGroup</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        setWillNotDraw(false)</span><br><span class="line">        updatePadding(top = topPadding.roundToInt())</span><br><span class="line">        dailyTaskListViewGroup = DailyTaskListViewGroup(context).apply &#123;</span><br><span class="line">            layoutParams = LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT)</span><br><span class="line">            setBackgroundColor(ScheduleConfig.colorBlack6)</span><br><span class="line">        &#125;</span><br><span class="line">        addView(dailyTaskListViewGroup)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    override fun onDetachedFromWindow() &#123;</span><br><span class="line">        super.onDetachedFromWindow()</span><br><span class="line">        // 只移除DayView，保留DailyTaskListViewGroup</span><br><span class="line">        removeViews(1, childCount - 1)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，我们的布局&amp;渲染框架就完成了。</p>
<h3 id="日历框架"><a href="#日历框架" class="headerlink" title="日历框架"></a>日历框架</h3><p>在<a target="_blank" rel="noopener" href="https://juejin.cn/post/7218459472919085114">上一篇</a>中我们已经定义好了日历框架，接下来，我们将给月视图绑定日历框架，并且让月视图和三日&#x2F;日视图联系起来。</p>
<p>在上一篇文章中，我们已经演示过日历框架的应用方式了。和日视图中的周控件一样，我们也让月视图相关的组件去实现<code>ICalendarRender</code>和<code>ICalendarParent</code>接口。由于相关控件比较多，这里就只贴一下<code>MonthGroup</code>的代码了，其他组件中的实现差不多。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class MonthGroup @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : RecyclerView(context, attrs), ICalendarRender, ICalendarParent &#123;</span><br><span class="line">    override val parentRender: ICalendarRender? = null</span><br><span class="line">    override val calendar: Calendar = beginOfDay()</span><br><span class="line">    override var selectedDayTime: Long by setter(nowMillis) &#123; _, time -&gt;</span><br><span class="line">        if (!isVisible) return@setter</span><br><span class="line">        childRenders.forEach &#123; it.selectedDayTime = time &#125;</span><br><span class="line">        post &#123;</span><br><span class="line">            val position = time.parseMonthIndex()</span><br><span class="line">            if (abs(lastPosition - position) &lt; 5) &#123;</span><br><span class="line">                smoothScrollToPosition(position)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                scrollToPosition(position)</span><br><span class="line">            &#125;</span><br><span class="line">            lastPosition = position</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    override var scheduleModels: List&lt;IScheduleModel&gt; by setter(emptyList()) &#123; _, list -&gt;</span><br><span class="line">        childRenders.forEach &#123; it.getSchedulesFrom(list) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    override val beginTime: Long</span><br><span class="line">        get() = ScheduleConfig.scheduleBeginTime</span><br><span class="line">    override val endTime: Long</span><br><span class="line">        get() = ScheduleConfig.scheduleEndTime</span><br><span class="line">    override val childRenders: List&lt;ICalendarRender&gt;</span><br><span class="line">        get() = children.filterIsInstance&lt;ICalendarRender&gt;().toList()</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意一下，当<code>ViewGroup</code>实现了<code>ICalendarParent</code>时，可以直接利用<code>filterIsInstance()</code>方法，在<code>ViewGroup</code>的<code>children</code>中遍历<code>childRenders</code>。不禁感叹，<strong>Kotlin特性可以大大简化我们的代码，并且能给我们编码提供更多想象空间。</strong></p>
<p>至此，我们的框架部分就搭建完成了。接下来，介绍一下部分具体实现。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="添加和布局DayView"><a href="#添加和布局DayView" class="headerlink" title="添加和布局DayView"></a>添加和布局DayView</h3><p>首先，我们需要计算<code>MonthView</code>中<code>DayView</code>的个数，这里我们可以利用<code>Calendar</code>计算出来。</p>
<p>咱们<code>ICalendarRender</code>不是实现了<code>ITimeRangeHolder</code>吗？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interface ITimeRangeHolder &#123; </span><br><span class="line">    val beginTime: Long </span><br><span class="line">    val endTime: Long </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface ICalendarRender : ITimeRangeHolder</span><br></pre></td></tr></table></figure>

<p>只要确定(实现)了<code>MonthView</code>中的<code>beginTime</code>和<code>endTime</code>，那么<code>(endTime - beginTime) / dayMillis</code>就是<code>DayView</code>的个数了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 当月第一天所在周的周日</span><br><span class="line">override val beginTime: Long</span><br><span class="line">    get() = beginOfDay(calendar.firstDayOfMonthTime).apply &#123;</span><br><span class="line">        set(Calendar.DAY_OF_WEEK, Calendar.SUNDAY)</span><br><span class="line">    &#125;.timeInMillis</span><br><span class="line">// 当月最后一天所在周的周六</span><br><span class="line">override val endTime: Long</span><br><span class="line">    get() = beginOfDay(calendar.lastDayOfMonthTime).apply &#123;</span><br><span class="line">        set(Calendar.DAY_OF_WEEK, Calendar.SATURDAY)</span><br><span class="line">    &#125;.timeInMillis</span><br></pre></td></tr></table></figure>

<p>这样，我们就可以在<code>onAttachedToWindow()</code>和<code>onLayout()</code>中处理<code>DayView</code>的添加、初始化和布局了。</p>
<p>PS：这里的<code>onLayout()</code>和日视图中的<code>WeekView</code>中的代码完全一样，哈哈！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">override fun onAttachedToWindow() &#123;</span><br><span class="line">    super.onAttachedToWindow()</span><br><span class="line">    for (time in beginTime..endTime step dayMillis) &#123;</span><br><span class="line">        DayView(context).let &#123; child -&gt;</span><br><span class="line">            child.calendar.timeInMillis = time</span><br><span class="line">            addView(child)</span><br><span class="line">            // 老样子，从parentRender中截取scheduleModels</span><br><span class="line">            if (scheduleModels.any()) &#123;</span><br><span class="line">                child.getSchedulesFrom(scheduleModels)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) &#123;</span><br><span class="line">    for (index in 0 until childCount) &#123;</span><br><span class="line">        val child = getChildAt(index)</span><br><span class="line">        val calendar = (child as ICalendarRender).calendar</span><br><span class="line">        val dDays = calendar.timeInMillis.dDays - beginTime.dDays</span><br><span class="line">        val line = dDays / 7</span><br><span class="line">        val left = dDays % 7 * dayWidth</span><br><span class="line">        val top = paddingTop + line * dayHeight</span><br><span class="line">        val right = left + dayWidth</span><br><span class="line">        val bottom = top + dayHeight</span><br><span class="line">        if (top.isNaN()) continue</span><br><span class="line">        child.layout(</span><br><span class="line">            left.roundToInt(),</span><br><span class="line">            top.roundToInt(),</span><br><span class="line">            right.roundToInt(),</span><br><span class="line">            bottom.roundToInt()</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="展开和收起"><a href="#展开和收起" class="headerlink" title="展开和收起"></a>展开和收起</h3><p>要实现展开和收起，根本上来说就是要改变<code>DayView</code>在<code>MonthView</code>中的位置（废话）。那么<code>DayView</code>的位置怎么改变呢，刚刚写的<code>onLayout()</code>方法中处理呗，让它的<code>top</code>可变就行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) &#123;</span><br><span class="line">    for (index in 0 until childCount) &#123;</span><br><span class="line">        ...</span><br><span class="line">        var top = paddingTop + line * dayHeight</span><br><span class="line">        // TODO top = ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>仔细看，点击<code>DayView</code>展开时，<code>DayView</code>所在的那一周向上滑动到顶部，下一周向下滑动到底部。</p>
<p>我们可以这样理解：展开时，有一条中心线(<code>collapseCenter</code>)，有一条线（<code>collapseTop</code>）从中心线开始向上挤，另一条线（<code>collapseBottom</code>）从中心线开始向下挤。</p>
<p><code>collapseCenter</code>是根据展开的那一周的行数(<code>collapseLine</code>)确定的，而<code>collapseTop</code>和<code>collapseBottom</code>是基于<code>collapseCenter</code>在展开动画中动态变化到目标位置的。</p>
<p>另外别忘了哦，展开时中间的日程列表<code>DailyTaskListViewGroup</code>和其他<code>ICalendarRender</code>一样，展开时需要为<code>DailyTaskListViewGroup</code>设置<code>calendar</code>和<code>scheduleModels</code>数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">// &gt; -1，展开； == -1，收起</span><br><span class="line">private var collapseLine = -1</span><br><span class="line">    set(value) &#123;</span><br><span class="line">        onCollapseLineChanged(field, value)</span><br><span class="line">        field = value</span><br><span class="line">    &#125;</span><br><span class="line">private var animatingCollapseLine = -1</span><br><span class="line">private var collapseCenter: Float = -1f</span><br><span class="line">private var collapseTop: Float = -1f</span><br><span class="line">private var collapseBottom: Float = -1f</span><br><span class="line"></span><br><span class="line">override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) &#123;</span><br><span class="line">    for (index in 0 until childCount) &#123;</span><br><span class="line">        ...</span><br><span class="line">        var top = paddingTop + line * dayHeight</span><br><span class="line">        if (animatingCollapseLine &gt;= 0) &#123;</span><br><span class="line">            if (line &lt;= animatingCollapseLine) &#123;</span><br><span class="line">                top -= collapseCenter - collapseTop</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                top += collapseBottom - collapseCenter</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private fun onCollapseLineChanged(old: Int, new: Int, doOnCollapsed: () -&gt; Unit = &#123;&#125;) &#123;</span><br><span class="line">    if (old == -1 &amp;&amp; new &gt;= 0) &#123; // 从收起到展开</span><br><span class="line">        // 展开时更新DailyTaskListViewGroup的日期和日程数据</span><br><span class="line">        dailyTaskListViewGroup.calendar.timeInMillis = beginTime + new * 7 * dayMillis</span><br><span class="line">        dailyTaskListViewGroup.getSchedulesFrom(scheduleModels)</span><br><span class="line">        collapseCenter = paddingTop + (new + 1) * dayHeight</span><br><span class="line">        val destTop = paddingTop + dayHeight</span><br><span class="line">        val destBottom = if (new &lt; childCount / 7 - 1) &#123;</span><br><span class="line">            paddingTop + (childCount / 7 - 1) * dayHeight</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            paddingTop + childCount / 7 * dayHeight</span><br><span class="line">        &#125;</span><br><span class="line">        ValueAnimator.ofFloat(0f, 1f).apply &#123;</span><br><span class="line">            doOnStart &#123;</span><br><span class="line">                animatingCollapseLine = new</span><br><span class="line">            &#125;</span><br><span class="line">            doOnEnd &#123;</span><br><span class="line">                animatingCollapseLine = new</span><br><span class="line">            &#125;</span><br><span class="line">            duration = 300</span><br><span class="line">            addUpdateListener &#123;</span><br><span class="line">                collapseTop = collapseCenter + (destTop - collapseCenter) * it.animatedFraction</span><br><span class="line">                collapseBottom =</span><br><span class="line">                    collapseCenter + (destBottom - collapseCenter) * it.animatedFraction</span><br><span class="line">                requestLayout()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125; else if (old &gt;= 0 &amp;&amp; new == -1) &#123; // 从展开到收起</span><br><span class="line">        dailyTaskListViewGroup.calendar.timeInMillis = -1</span><br><span class="line">        dailyTaskListViewGroup.scheduleModels = emptyList()</span><br><span class="line">        collapseCenter = paddingTop + (old + 1) * dayHeight</span><br><span class="line">        val startTop = collapseTop</span><br><span class="line">        val startBottom = collapseBottom</span><br><span class="line">        ValueAnimator.ofFloat(0f, 1f).apply &#123;</span><br><span class="line">            doOnStart &#123;</span><br><span class="line">                animatingCollapseLine = old</span><br><span class="line">            &#125;</span><br><span class="line">            doOnEnd &#123;</span><br><span class="line">                animatingCollapseLine = new</span><br><span class="line">                doOnCollapsed.invoke()</span><br><span class="line">            &#125;</span><br><span class="line">            duration = 300</span><br><span class="line">            addUpdateListener &#123;</span><br><span class="line">                collapseTop = startTop + (collapseCenter - startTop) * it.animatedFraction</span><br><span class="line">                collapseBottom =</span><br><span class="line">                    startBottom + (collapseCenter - startBottom) * it.animatedFraction</span><br><span class="line">                requestLayout()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line">    &#125; else if (old != new &amp;&amp; old &gt;= 0 &amp;&amp; new &gt;= 0) &#123; // 从展开第a行到展开第b行，连续调用两次</span><br><span class="line">        onCollapseLineChanged(old, -1) &#123;</span><br><span class="line">            onCollapseLineChanged(-1, new)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="滑动冲突"><a href="#滑动冲突" class="headerlink" title="滑动冲突"></a>滑动冲突</h3><p>日程列表<code>DailyTaskListViewGroup</code>中是横向<code>RecyclerView</code>嵌套纵向<code>RecyclerView</code>，<code>MonthGroup</code>又是一个横向<code>RecyclerView</code>，所以我们需要处理一下滑动冲突。</p>
<p>简单来说，就是在我们左右滑动日程列表时，通过调用<code>parent.requestDisallowInterceptTouchEvent(true)</code>，不让父布局拦截事件就行了。这边简单贴一下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">open class StableOrientationRecyclerView @JvmOverloads constructor(</span><br><span class="line">    context: Context, attrs: AttributeSet? = null</span><br><span class="line">) : RecyclerView(context, attrs) &#123;</span><br><span class="line">    private var downX = 0f</span><br><span class="line">    private var downY = 0f</span><br><span class="line">    private var justDown = false</span><br><span class="line">    private val isHorizontal: Boolean</span><br><span class="line">        get() = (layoutManager as? LinearLayoutManager)?.orientation == HORIZONTAL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private val touchSlop = ViewConfiguration.getTouchSlop()</span><br><span class="line"></span><br><span class="line">    override fun dispatchTouchEvent(e: MotionEvent): Boolean &#123;</span><br><span class="line">        when (e.action) &#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                downX = e.x</span><br><span class="line">                downY = e.y</span><br><span class="line">                justDown = true</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                if (justDown &amp;&amp; (abs(downX - e.x) &gt; touchSlop || abs(downY - e.y) &gt; touchSlop)) &#123;</span><br><span class="line">                    val moveHorizontal = abs(downX - e.x) &gt; abs(downY - e.y)</span><br><span class="line">                    if (moveHorizontal == isHorizontal) &#123;</span><br><span class="line">                        parent.requestDisallowInterceptTouchEvent(true)</span><br><span class="line">                    &#125;</span><br><span class="line">                    justDown = false</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                justDown = false</span><br><span class="line">                parent.requestDisallowInterceptTouchEvent(false)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return super.dispatchTouchEvent(e)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后让<code>DailyTaskListViewGroup</code>继承<code>StableOrientationRecyclerView</code>就完事了。</p>
<h2 id="杀割"><a href="#杀割" class="headerlink" title="杀割"></a>杀割</h2><p>本文介绍的月视图，相对于三日&#x2F;日视图来说，更加接近平时我们在工作中接到的需求，做起来比较枯燥一点。好在有先前就定义好的日历框架加持，笔者在做实现时还比较顺畅。</p>
<p>后面笔者将介绍最后一个日程视图了，先贴一张效果图预告，感兴趣的朋友可以关注一下。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da24e40285134cfab25eb37c91b7cb7c~tplv-k3u1fbpfcp-watermark.image" alt="列表视图.gif"></p>
<p>最后贴一下<a target="_blank" rel="noopener" href="https://github.com/blackfrogxxoo/ScheduleView/tree/master/widget/src/main/java/me/wxc/widget/calender">代码地址</a>，欢迎star和issues。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/04/05/schedule2/" rel="prev" title="【Android自定义View】高仿飞书日历--日视图">
                  <i class="fa fa-angle-left"></i> 【Android自定义View】高仿飞书日历--日视图
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/05/02/schedule4/" rel="next" title="【Android自定义View】高仿飞书日历--列表视图">
                  【Android自定义View】高仿飞书日历--列表视图 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">blackfrog</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
